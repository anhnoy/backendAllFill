// Test TDAC Registration API with complete user data
const http = require('http');

function makeJSONRequest(url, data) {
  return new Promise((resolve, reject) => {
    const postData = JSON.stringify(data);
    
    const options = {
      hostname: 'localhost',
      port: 5000,
      path: url.replace('http://localhost:5000', ''),
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(postData)
      }
    };

    const req = http.request(options, (res) => {
      let responseData = '';
      
      res.on('data', (chunk) => {
        responseData += chunk;
      });
      
      res.on('end', () => {
        try {
          const jsonData = JSON.parse(responseData);
          resolve({
            status: res.statusCode,
            data: jsonData
          });
        } catch (error) {
          resolve({
            status: res.statusCode,
            data: responseData
          });
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    req.write(postData);
    req.end();
  });
}

async function testCompleteUserRegistration() {
  console.log('üß™ Testing TDAC Registration with Complete User Data');
  console.log('=' .repeat(70));

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á - ‡∏ä‡∏≤‡∏ß‡∏•‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏°‡∏≤‡πÑ‡∏ó‡∏¢
  const completeUserData = {
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
    occupation: "employee",           // ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    gender: "MALE",                  // ‡πÄ‡∏û‡∏®: ‡∏ä‡∏≤‡∏¢
    phoneNumber: "+856-20-5555-1234", // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏•‡∏≤‡∏ß
    visaNumber: "LA2024001234",      // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ß‡∏µ‡∏ã‡πà‡∏≤
    cityStateOfResidence: "Vientiane", // ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢: ‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏ô‡πå
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
    dateOfArrival: "2025-12-25",     // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏°‡∏≤: ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™
    purposeOfTravel: "HOLIDAY",      // ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß
    modeOfTravel: "AIR",            // ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: ‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
    modeOfTransport: "COMMERCIAL_FLIGHT", // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå
    flightVehicleNumber: "QV301",    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏¥‡∏ô Lao Airlines
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á)
    isTransitPassenger: "false",     // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà transit passenger
    typeOfAccommodation: "Hotel",    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å: ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°
    province: "Bangkok",             // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û
    address: "Siam Paragon Hotel, 991 Rama I Road, Pathumwan, Bangkok 10330", // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å
    
    // URLs ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
    passportPhotoUrl: "https://example.com/uploads/passport-somchai-2024.jpg",
    paymentSlipUrl: "https://example.com/uploads/payment-slip-001234.jpg"
  };

  try {
    console.log('üë§ User Profile:');
    console.log(`   Name: Somchai Laovilai (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)`);
    console.log(`   Nationality: Lao PDR`);
    console.log(`   Purpose: Christmas Holiday in Thailand`);
    console.log('');

    console.log('üì§ Sending Registration Request...');
    console.log('URL: POST http://localhost:5000/api/tdac/register');
    console.log('Content-Type: application/json');
    console.log('');
    console.log('üìã Request Data:');
    console.log(JSON.stringify(completeUserData, null, 2));
    console.log('-'.repeat(50));

    const result = await makeJSONRequest('http://localhost:5000/api/tdac/register', completeUserData);
    
    console.log('üì• Server Response:');
    console.log(`Status Code: ${result.status}`);
    console.log('Response Body:');
    console.log(JSON.stringify(result.data, null, 2));
    console.log('-'.repeat(50));
    
    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    if (result.status === 201 && result.data.success) {
      console.log('‚úÖ REGISTRATION SUCCESSFUL!');
      console.log('');
      console.log('üìù Registration Details:');
      console.log(`   Registration ID: ${result.data.data.id}`);
      console.log(`   Status: ${result.data.data.status}`);
      console.log(`   Submitted At: ${new Date(result.data.data.createdAt).toLocaleString()}`);
      console.log(`   Occupation: ${result.data.data.occupation}`);
      console.log(`   Gender: ${result.data.data.gender}`);
      console.log(`   Phone: ${result.data.data.phoneNumber}`);
      console.log(`   Arrival Date: ${result.data.data.dateOfArrival}`);
      console.log(`   Purpose: ${result.data.data.purposeOfTravel}`);
      console.log(`   Flight: ${result.data.data.flightVehicleNumber}`);
      console.log(`   Accommodation: ${result.data.data.typeOfAccommodation} in ${result.data.data.province}`);
      console.log(`   Transit Passenger: ${result.data.data.isTransitPassenger ? 'Yes' : 'No'}`);
      
      if (result.data.data.passportPhotoUrl) {
        console.log(`   Passport Photo: ${result.data.data.passportPhotoUrl}`);
      }
      if (result.data.data.paymentSlipUrl) {
        console.log(`   Payment Slip: ${result.data.data.paymentSlipUrl}`);
      }
      
      return result.data.data.id;
    } else {
      console.log('‚ùå REGISTRATION FAILED!');
      console.log('');
      console.log('üí¨ Error Message:', result.data.message || 'Unknown error');
      if (result.data.errors) {
        console.log('üîç Validation Errors:');
        Object.entries(result.data.errors).forEach(([field, error]) => {
          console.log(`   ${field}: ${error}`);
        });
      }
      return null;
    }
    
  } catch (error) {
    console.error('üí• Network/Connection Error:', error.message);
    console.log('‚ùå REGISTRATION FAILED!');
    return null;
  }
}

async function testBusinessTraveler() {
  console.log('\nüß™ Testing Business Traveler Registration');
  console.log('=' .repeat(70));

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
  const businessTravelerData = {
    occupation: "seller",             // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å business_owner ‡πÄ‡∏õ‡πá‡∏ô seller
    gender: "FEMALE",
    phoneNumber: "+856-21-444-5678",
    visaNumber: "LA2024005678",
    cityStateOfResidence: "Luang Prabang",
    dateOfArrival: "2025-11-15",
    purposeOfTravel: "BUSINESS",
    modeOfTravel: "AIR",
    modeOfTransport: "PRIVATE_PLANE",
    flightVehicleNumber: "PVT-001",
    isTransitPassenger: "false",
    typeOfAccommodation: "Hotel",
    province: "Chiang Mai",
    address: "The Dhara Dhevi, 51/4 Chiang Mai-Sankampaeng Road, Mueang Chiang Mai, Chiang Mai 50000",
    passportPhotoUrl: "https://example.com/uploads/passport-business-001.jpg",
    paymentSlipUrl: "https://example.com/uploads/payment-business-001.jpg"
  };

  try {
    console.log('üë©‚Äçüíº Business Traveler Profile:');
    console.log(`   Name: Kham Phonepadith (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)`);
    console.log(`   Occupation: Business Owner`);
    console.log(`   Purpose: Business Meeting in Chiang Mai`);
    console.log('');

    const result = await makeJSONRequest('http://localhost:5000/api/tdac/register', businessTravelerData);
    
    console.log('üì• Server Response:');
    console.log(`Status Code: ${result.status}`);
    console.log('Response Body:');
    console.log(JSON.stringify(result.data, null, 2));
    
    if (result.status === 201 && result.data.success) {
      console.log('‚úÖ BUSINESS TRAVELER REGISTRATION SUCCESSFUL!');
      return result.data.data.id;
    } else {
      console.log('‚ùå BUSINESS TRAVELER REGISTRATION FAILED!');
      return null;
    }
    
  } catch (error) {
    console.error('üí• Error:', error.message);
    return null;
  }
}

async function testTransitPassenger() {
  console.log('\nüß™ Testing Transit Passenger Registration');
  console.log('=' .repeat(70));

  // ‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å)
  const transitPassengerData = {
    occupation: "freelancer",         // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å student ‡πÄ‡∏õ‡πá‡∏ô freelancer
    gender: "MALE",
    phoneNumber: "+856-20-999-1111",
    cityStateOfResidence: "Pakse",
    dateOfArrival: "2025-10-20",
    purposeOfTravel: "OTHERS",        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å OTHER ‡πÄ‡∏õ‡πá‡∏ô OTHERS
    modeOfTravel: "AIR",
    modeOfTransport: "COMMERCIAL_FLIGHT",
    flightVehicleNumber: "TG575",
    isTransitPassenger: "true" // Transit passenger - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å
  };

  try {
    console.log('üéì Transit Student Profile:');
    console.log(`   Name: Bounmy Sisavath (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)`);
    console.log(`   Occupation: Student`);
    console.log(`   Purpose: Transit to Singapore`);
    console.log('');

    const result = await makeJSONRequest('http://localhost:5000/api/tdac/register', transitPassengerData);
    
    console.log('üì• Server Response:');
    console.log(`Status Code: ${result.status}`);
    console.log('Response Body:');
    console.log(JSON.stringify(result.data, null, 2));
    
    if (result.status === 201 && result.data.success) {
      console.log('‚úÖ TRANSIT PASSENGER REGISTRATION SUCCESSFUL!');
      return result.data.data.id;
    } else {
      console.log('‚ùå TRANSIT PASSENGER REGISTRATION FAILED!');
      return null;
    }
    
  } catch (error) {
    console.error('üí• Error:', error.message);
    return null;
  }
}

async function runCompleteTests() {
  console.log('üöÄ TDAC Registration API - Complete User Testing');
  console.log('üìÖ Test Date:', new Date().toLocaleString());
  console.log('üåê Server: http://localhost:5000');
  console.log('üîß API Endpoint: POST /api/tdac/register');
  console.log('üìù Content-Type: application/json');
  console.log('');

  const results = {};

  // Test 1: Complete Holiday Traveler
  results.holidayTraveler = await testCompleteUserRegistration();

  // Test 2: Business Traveler  
  results.businessTraveler = await testBusinessTraveler();

  // Test 3: Transit Passenger
  results.transitPassenger = await testTransitPassenger();

  // Summary
  console.log('\nüìä TEST RESULTS SUMMARY');
  console.log('=' .repeat(70));
  
  const testResults = [
    { name: 'Holiday Traveler', id: results.holidayTraveler },
    { name: 'Business Traveler', id: results.businessTraveler },
    { name: 'Transit Passenger', id: results.transitPassenger }
  ];

  testResults.forEach((test, index) => {
    const status = test.id ? '‚úÖ PASSED' : '‚ùå FAILED';
    const idInfo = test.id ? ` (ID: ${test.id})` : '';
    console.log(`${index + 1}. ${test.name}: ${status}${idInfo}`);
  });

  const passedTests = testResults.filter(test => test.id).length;
  const totalTests = testResults.length;

  console.log('');
  console.log(`üéØ Overall Result: ${passedTests}/${totalTests} tests passed`);
  
  if (passedTests === totalTests) {
    console.log('üéâ ALL TESTS PASSED! TDAC Registration API is working perfectly!');
    console.log('‚ú® Ready for production use with frontend integration.');
  } else {
    console.log('‚ö†Ô∏è  Some tests failed. Please check the API implementation.');
  }

  console.log('');
  console.log('üîó Next Steps for Frontend Integration:');
  console.log('   1. Use these JSON examples for frontend form submission');
  console.log('   2. Handle success/error responses appropriately');
  console.log('   3. Display registration ID to users upon success');
  console.log('   4. Implement file upload for passport photos and payment slips');
}

// Run all tests
if (require.main === module) {
  runCompleteTests().catch(console.error);
}

module.exports = {
  testCompleteUserRegistration,
  testBusinessTraveler,
  testTransitPassenger,
  runCompleteTests
};
